# Homework 4 As Cool As It Gets

import numpy as np
import scipy.sparse as sp
from scipy.integrate import solve_ivp
from matplotlib.animation import FuncAnimation
from IPython import display
import matplotlib.pyplot as plt
import imageio

# Problem 1

# Part a)

# Initializing Variables

N = 64
L = 20.0
nu = 0.001

x_start = -L/2
x_end = L/2
y_start = x_start
y_end = x_end
delta = L/N

t_start = 0.0
t_end = 20.0
t_span = [t_start, t_end]
delta_t = 0.2
t_eval = np.arange(t_start, t_end + delta_t, delta_t)
delta_t = t_eval[1] - t_eval[0]

# Partial Derivative Matrices from Central Difference



amongus = np.array([
  [0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.1640625, 0.0078125, 0.01171875, 0.00390625, 0.00390625, 0.00390625, 0.00390625, 0.30859375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375],
  [0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.0078125, 0.0078125, 0.0, 0.0, 0.0, 0.015625, 0.08203125, 0.0703125, 0.0078125, 0.0, 0.0, 0.0, 0.00390625, 0.64453125, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375],
  [0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.0, 0.00390625, 0.00390625, 0.125, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.31640625, 0.0078125, 0.0, 0.0, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375],
  [0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.9921875, 0.0, 0.0078125, 0.3515625, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.21484375, 0.00390625, 0.00390625, 0.9921875, 0.99609375, 0.99609375, 0.99609375, 0.99609375],
  [0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.17578125, 0.0, 0.234375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.33203125, 0.33984375, 0.33984375, 0.3359375, 0.33984375, 0.265625, 0.0, 0.4296875, 0.99609375, 0.99609375, 0.99609375, 0.99609375],
  [0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.0, 0.00390625, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.09375, 0.01171875, 0.00390625, 0.00390625, 0.0, 0.0, 0.0, 0.0, 0.00390625, 0.0, 0.0, 0.98828125, 0.99609375, 0.99609375, 0.99609375],
  [0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.98046875, 0.0, 0.0390625, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.328125, 0.01171875, 0.0, 0.015625, 0.07421875, 0.61328125, 0.73828125, 0.734375, 0.73828125, 0.7421875, 0.75, 0.65234375, 0.0078125, 0.00390625, 0.0078125, 0.44140625, 0.99609375, 0.99609375],
  [0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.12109375, 0.0, 0.22265625, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.0, 0.00390625, 0.734375, 0.73828125, 0.73828125, 0.73828125, 0.7734375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.734375, 0.0078125, 0.0, 0.40234375, 0.99609375],
  [0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.0078125, 0.00390625, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.0078125, 0.00390625, 0.7421875, 0.73828125, 0.73828125, 0.73828125, 0.73828125, 0.9921875, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.9921875, 0.734375, 0.02734375, 0.0, 0.984375],
  [0.99609375, 0.99609375, 0.2578125, 0.0, 0.0, 0.0, 0.0, 0.0078125, 0.33203125, 0.3359375, 0.3359375, 0.3359375, 0.33984375, 0.0, 0.0859375, 0.73828125, 0.73828125, 0.73828125, 0.73828125, 0.73828125, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.7421875, 0.73828125, 0.71875, 0.0, 0.015625],
  [0.99609375, 0.03125, 0.0, 0.00390625, 0.27734375, 0.31640625, 0.0, 0.00390625, 0.2578125, 0.3359375, 0.3359375, 0.3359375, 0.27734375, 0.0078125, 0.3671875, 0.359375, 0.7421875, 0.73828125, 0.73828125, 0.73828125, 0.73046875, 0.7421875, 0.75390625, 0.76171875, 0.7578125, 0.734375, 0.734375, 0.73828125, 0.73828125, 0.73828125, 0.01953125, 0.00390625],
  [0.94140625, 0.0, 0.10546875, 0.3359375, 0.3359375, 0.34375, 0.00390625, 0.00390625, 0.24609375, 0.3359375, 0.3359375, 0.3359375, 0.328125, 0.0, 0.328125, 0.36328125, 0.36328125, 0.73046875, 0.75390625, 0.734375, 0.73828125, 0.73828125, 0.73828125, 0.73828125, 0.73828125, 0.73828125, 0.73828125, 0.73828125, 0.73046875, 0.37109375, 0.00390625, 0.00390625],
  [0.05859375, 0.0, 0.3359375, 0.3359375, 0.3359375, 0.33984375, 0.0, 0.0, 0.24609375, 0.33203125, 0.3359375, 0.3359375, 0.33203125, 0.0, 0.0, 0.36328125, 0.36328125, 0.36328125, 0.36328125, 0.36328125, 0.6640625, 0.734375, 0.73046875, 0.734375, 0.74609375, 0.59375, 0.375, 0.36328125, 0.375, 0.01171875, 0.0, 0.2890625],
  [0.0, 0.0, 0.24609375, 0.2421875, 0.24609375, 0.23828125, 0.00390625, 0.0, 0.24609375, 0.28125, 0.3359375, 0.3359375, 0.33203125, 0.31640625, 0.0, 0.0078125, 0.36328125, 0.359375, 0.36328125, 0.36328125, 0.36328125, 0.36328125, 0.36328125, 0.36328125, 0.36328125, 0.36328125, 0.359375, 0.17578125, 0.0, 0.0, 0.00390625, 0.99609375],
  [0.01171875, 0.0078125, 0.24609375, 0.24609375, 0.24609375, 0.23828125, 0.00390625, 0.0078125, 0.24609375, 0.234375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.35546875, 0.00390625, 0.0, 0.0078125, 0.00390625, 0.19140625, 0.34375, 0.30859375, 0.1953125, 0.00390625, 0.00390625, 0.0, 0.0, 0.0, 0.0, 0.87109375, 0.98046875, 0.99609375],
  [0.0, 0.00390625, 0.24609375, 0.24609375, 0.24609375, 0.23828125, 0.00390625, 0.0078125, 0.24609375, 0.23828125, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.03515625, 0.00390625, 0.01171875, 0.0078125, 0.0, 0.0, 0.00390625, 0.0, 0.0078125, 0.15234375, 0.328125, 0.0, 0.99609375, 0.99609375, 0.99609375],
  [0.0, 0.0, 0.24609375, 0.24609375, 0.24609375, 0.2421875, 0.00390625, 0.00390625, 0.24609375, 0.24609375, 0.328125, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.33203125, 0.0, 0.80859375, 0.99609375, 0.99609375],
  [0.0, 0.0, 0.24609375, 0.24609375, 0.24609375, 0.2421875, 0.00390625, 0.00390625, 0.24609375, 0.24609375, 0.24609375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.33203125, 0.0, 0.68359375, 0.99609375, 0.99609375],
  [0.0078125, 0.00390625, 0.24609375, 0.24609375, 0.24609375, 0.25390625, 0.00390625, 0.00390625, 0.24609375, 0.24609375, 0.24609375, 0.23828125, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.33203125, 0.0, 0.63671875, 0.99609375, 0.99609375],
  [0.015625, 0.0, 0.25, 0.24609375, 0.24609375, 0.2421875, 0.0, 0.00390625, 0.24609375, 0.24609375, 0.24609375, 0.2421875, 0.24609375, 0.30859375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.3359375, 0.33203125, 0.0, 0.91015625, 0.99609375, 0.99609375],
  [0.00390625, 0.0, 0.24609375, 0.24609375, 0.24609375, 0.2421875, 0.0, 0.00390625, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.25, 0.2578125, 0.28125, 0.28125, 0.28125, 0.26171875, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.20703125, 0.0, 0.99609375, 0.99609375, 0.99609375],
  [0.484375, 0.0, 0.203125, 0.24609375, 0.24609375, 0.2421875, 0.0, 0.00390625, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.140625, 0.00390625, 0.99609375, 0.99609375, 0.99609375],
  [0.99609375, 0.0, 0.0078125, 0.24609375, 0.24609375, 0.23828125, 0.0, 0.00390625, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.08203125, 0.00390625, 0.99609375, 0.99609375, 0.99609375],
  [0.99609375, 0.00390625, 0.0078125, 0.24609375, 0.24609375, 0.25, 0.0, 0.01171875, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.0234375, 0.0, 0.99609375, 0.99609375, 0.99609375],
  [0.99609375, 0.9765625, 0.015625, 0.0, 0.0, 0.01171875, 0.00390625, 0.0078125, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.23046875, 0.25390625, 0.25, 0.22265625, 0.0078125, 0.0, 0.078125, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.015625, 0.00390625, 0.99609375, 0.99609375, 0.99609375],
  [0.99609375, 0.99609375, 0.99609375, 0.515625, 0.00390625, 0.0234375, 0.015625, 0.00390625, 0.25, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.2421875, 0.00390625, 0.0078125, 0.0078125, 0.01171875, 0.0, 0.24609375, 0.2421875, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.0, 0.00390625, 0.99609375, 0.99609375, 0.99609375],
  [0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.984375, 0.0, 0.23046875, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.2421875, 0.0, 0.99609375, 0.99609375, 0.0, 0.0, 0.25390625, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.00390625, 0.00390625, 0.99609375, 0.99609375, 0.99609375],
  [0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.0, 0.10546875, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.0, 0.99609375, 0.99609375, 0.0078125, 0.0, 0.2421875, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.00390625, 0.015625, 0.99609375, 0.99609375, 0.99609375],
  [0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.0, 0.02734375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.25390625, 0.0, 0.9921875, 0.99609375, 0.00390625, 0.0, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.2578125, 0.0, 0.6171875, 0.99609375, 0.99609375, 0.99609375],
  [0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.0, 0.0078125, 0.24609375, 0.24609375, 0.24609375, 0.24609375, 0.25390625, 0.23828125, 0.01171875, 0.00390625, 0.99609375, 0.99609375, 0.0078125, 0.0, 0.26171875, 0.23828125, 0.24609375, 0.25390625, 0.0546875, 0.00390625, 0.0078125, 0.99609375, 0.99609375, 0.99609375, 0.99609375],
  [0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.0078125, 0.0, 0.0078125, 0.23828125, 0.24609375, 0.25, 0.03515625, 0.0, 0.0, 0.99609375, 0.98828125, 0.99609375, 0.99609375, 0.015625, 0.0, 0.00390625, 0.0, 0.0, 0.0, 0.01953125, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375],
  [0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.05859375, 0.0, 0.0, 0.0, 0.0, 0.33984375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.98828125, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.9921875, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375, 0.99609375]
]
)



# Matrix A - Laplacian matrix

# A[1,1] = 2 To avoid having a singular matrix
main_diag = -4*np.ones(N**2)
main_diag[0] = 2

A_D = sp.spdiags(data = [main_diag], diags = 0, m = N**2, n = N**2)

boundary_diag_y_lower = np.zeros(N)
boundary_diag_y_lower[0] = 1
boundary_diag_y_lower = np.concatenate([boundary_diag_y_lower]*N)

boundary_diag_y_upper = np.zeros(N)
boundary_diag_y_upper[-1] = 1
boundary_diag_y_upper = np.concatenate([boundary_diag_y_upper]*N)

upper_first_diag = np.ones(N**2)
lower_first_diag = np.ones(N**2)

for i in range(N):
    upper_first_diag[N*i] = 0

for i in range(N):
    lower_first_diag[N*i - 1] = 0

data_y = np.array([upper_first_diag, lower_first_diag, boundary_diag_y_upper, boundary_diag_y_lower])

A_y = sp.spdiags(data = data_y, diags = [1, -1, N-1, -(N-1)], m = N**2, n = N**2)

data_x = np.ones((4, N**2))

A_x = sp.spdiags(data = data_x, diags = [N, -N, N**2 - N, -(N**2 - N)], m = N**2, n = N**2)

A = A_D + A_x + A_y

A = (1/(delta**2))*A

# Matrix B - Partial derivative in x

data_Bx = np.ones((4, N**2))
data_Bx[1] = -np.ones(N**2)
data_Bx[2] = -np.ones(N**2)

B_x = sp.spdiags(data = data_Bx, diags = [N, -N, N**2 - N, -(N**2 - N)], m = N**2, n = N**2)

B = (1/(2*delta))*B_x

# Matrix C - Partial derivative in y

boundary_diag_y_lower = np.zeros(N)
boundary_diag_y_lower[0] = 1
boundary_diag_y_lower = np.concatenate([boundary_diag_y_lower]*N)

boundary_diag_y_upper = np.zeros(N)
boundary_diag_y_upper[-1] = 1
boundary_diag_y_upper = np.concatenate([boundary_diag_y_upper]*N)

data_y = np.array([upper_first_diag, -lower_first_diag, -boundary_diag_y_upper, boundary_diag_y_lower])

C_y = sp.spdiags(data = data_y, diags = [1, -1, N-1, -(N-1)], m = N**2, n = N**2)

C = (1/(2*delta))*C_y


# Matrices to CSC for faster computation

A = A.tocsc()
B = B.tocsc()
C = C.tocsc()

# Initial Condition for Omega at t = 0

def initial_omega(x,y):
    return x**2/100 + y**2/100

# Initialize omega_0

x = np.arange(x_start, x_end, delta)
y = np.arange(y_start, y_end, delta)

X,Y = np.meshgrid(x,y)

omega_0_matrix = initial_omega(X,Y)

start_slice = N // 4
end_slice = 3*N // 4

omega_0_matrix[start_slice: end_slice, start_slice : end_slice] = np.flipud(amongus)

omega_0 = omega_0_matrix.flatten(order = 'F')

# Fourier Method

k_x = 2*np.pi*np.fft.fftfreq(N, d = delta)
k_y = 2*np.pi*np.fft.fftfreq(N, d = delta)
k_x[0] = 1e-6
k_y[0] = 1e-6

K_X, K_Y = np.meshgrid(k_x, k_y)

reciprocal_K = 1/(K_X**2 + K_Y**2)

def F_Fourier(t, omega):

    omega_matrix = np.reshape(omega, (N,N), order = 'F')

    fft2_omega = np.fft.fft2(omega_matrix)

    fft2_psi = -fft2_omega*reciprocal_K

    psi_matrix = np.real(np.fft.ifft2(fft2_psi))

    psi = psi_matrix.flatten(order = 'F')

    output = (C @ psi)*(B @ omega) - (B @ psi)*(C @ omega) + nu*(A @ omega)

    return output

sol_Fourier = solve_ivp(F_Fourier, t_span = t_span, y0 = omega_0, t_eval = t_eval)

# GIF creator

def plotting_function(t, omega, X, Y, N):
    frames = []
    for j in range(len(t)):
        current_omega = omega[:, j].reshape((N, N), order='F')

        plt.figure(figsize=(5, 4))
        plt.imshow(current_omega, origin = 'lower', cmap = 'coolwarm')
        plt.axis('off')
        
        plt.savefig("frame.png", dpi=100)
        plt.close()

        frames.append(imageio.v2.imread("frame.png"))
    return frames

frames = plotting_function(sol_Fourier.t, np.fliplr(sol_Fourier.y), X, Y, N)
imageio.mimsave("Surprise.gif", frames, duration=delta_t)



# 2D Top Down Heat Map Plotter

"""plt.ion()

fig, ax = plt.subplots(figsize=(10, 8))

sol_Fourier.y = np.fliplr(sol_Fourier.y)

for i in range(len(sol_Fourier.y.T)):
    psi = sol_Fourier.y[:, i]

    X, Y = np.meshgrid(x, y)
    Z = np.reshape(psi, (N, N), order = 'F')

    ax.clear()  # Clear previous frame
    plt.imshow(Z, origin = 'lower', cmap='coolwarm')

    ax.set_title(f'2D Plot (t = {t_eval[i]:.3f})')
    ax.set_xlabel('x')
    ax.set_ylabel('y')

    plt.pause(0.01)   # brief pause lets GUI update

plt.ioff()  # (optional) turn off interactive mode at end
plt.show()
"""
# Plot 3D solution in time

"""plt.ion()

fig = plt.figure(figsize=(10, 8))
ax = plt.axes(projection='3d')

for i in range(len(t_eval)):
    psi = sol_Fourier.y[:, i]

    X, Y = np.meshgrid(x, y)
    Z = np.flipud(np.reshape(psi, (N, N), order='F'))

    ax.clear()  # Clear previous frame
    ax.plot_surface(X, Y, Z, cmap='coolwarm')

    ax.set_title(f'3D Plot (t = {t_eval[i]:.3f})')
    ax.set_xlabel('x')
    ax.set_ylabel('y')
    ax.set_zlabel('z')

    plt.pause(0.01)   # brief pause lets GUI update

plt.ioff()  # (optional) turn off interactive mode at end

plt.show()
"""





